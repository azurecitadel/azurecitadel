{{ define "main" }}

<div class="container-xl p-3 p-md-6 width-full">

    <!-- main header (hamburger + breadcrumbs) now rendered globally in base layout -->

    {{/* Compute series neighbors once so we can use in TOC header and footer */}}
    {{ if isset .Params "series" }}
        {{ $seriesTitle := index .Params.series 0 }}
        {{ $currentLink := .Permalink }}
        {{ $allSeriesPages := (index .Site.Taxonomies.series ($seriesTitle | urlize)).Pages }}

        {{/* Custom sort: _index.md first, then by weight */}}
        {{ $indexPages := slice }}
        {{ $otherPages := slice }}
        {{ range $allSeriesPages }}
            {{ if eq .File.LogicalName "_index.md" }}
                {{ $indexPages = $indexPages | append . }}
            {{ else }}
                {{ $otherPages = $otherPages | append . }}
            {{ end }}
        {{ end }}
        {{ $sortedOthers := sort $otherPages "Params.weight" }}
        {{ $wholeSeries := $indexPages | append $sortedOthers }}

        {{/* Store sorted series for reuse */}}
        {{ .Scratch.Set "wholeSeries" $wholeSeries }}

        {{ range $index, $page := $wholeSeries }}
            {{ if eq $currentLink $page.Permalink }}
                {{ .Scratch.Set "currentIndex" $index }}
                {{ if gt $index 0 }}
                    {{ .Scratch.Set "prevInSeries" (index $wholeSeries (sub $index 1)) }}
                {{ end }}
                {{ if lt $index (sub (len $wholeSeries) 1) }}
                    {{ .Scratch.Set "nextInSeries" (index $wholeSeries (add $index 1)) }}
                {{ end }}
            {{ end }}
        {{ end }}
    {{ end }}

    <div class="d-flex flex-column flex-xl-row-reverse markdown-body">

        <div class="toc" style="flex: 0 0 300px; align-self: flex-start;">
            <div style="position: sticky; top: 1rem; padding: 0.75rem; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 2px 8px rgba(140,149,159,0.1);">
                <div class="toc-header d-flex flex-items-center pb-2 mb-2 border-bottom color-border-muted">
                    {{ if isset .Params "series" }}
                        {{/* Series Progress Indicator - reuse computed values */}}
                        {{ $wholeSeries := index .Scratch.Values "wholeSeries" }}
                        {{ $currentIndex := index .Scratch.Values "currentIndex" }}
                        {{ if not $currentIndex }}{{ $currentIndex = 0 }}{{ end }}
                        <div class="series-progress-container">
                            <div class="series-name">{{ .Title }}</div>
                            <div class="series-controls">
                                {{ with index .Scratch.Values "prevInSeries" }}
                                    <a class="btn-octicon series-btn" href="{{ .Permalink }}" aria-label="Previous in series: {{ .Title }}" title="{{ .Title }}">{{- partial "octicon" (dict "icon" "chevron-left" "height" 16) -}}</a>
                                {{ else }}
                                    <span class="btn-octicon series-btn is-disabled" aria-disabled="true" title="No previous page">{{- partial "octicon" (dict "icon" "chevron-left" "height" 16) -}}</span>
                                {{ end }}
                                <div class="series-progress" aria-label="Series progress: {{ add $currentIndex 1 }} of {{ len $wholeSeries }}">
                                {{ range $index, $page := $wholeSeries }}
                                    {{ $status := "future" }}
                                    {{ if lt $index $currentIndex }}{{ $status = "completed" }}{{ end }}
                                    {{ if eq $index $currentIndex }}{{ $status = "current" }}{{ end }}
                                    {{ if eq $index $currentIndex }}
                                        <div class="progress-bar progress-bar--{{ $status }}"
                                             title="{{ $page.Title }}">
                                        </div>
                                    {{ else }}
                                        <a href="{{ $page.Permalink }}"
                                           class="progress-bar progress-bar--{{ $status }}"
                                           title="{{ $page.Title }}"
                                           aria-label="Go to {{ $page.Title }}">
                                        </a>
                                    {{ end }}
                                {{ end }}
                                </div>
                                {{ with index .Scratch.Values "nextInSeries" }}
                                    <a class="btn-octicon series-btn" href="{{ .Permalink }}" aria-label="Next in series: {{ .Title }}" title="{{ .Title }}">{{- partial "octicon" (dict "icon" "chevron-right" "height" 16) -}}</a>
                                {{ else }}
                                    <span class="btn-octicon series-btn is-disabled" aria-disabled="true" title="No next page">{{- partial "octicon" (dict "icon" "chevron-right" "height" 16) -}}</span>
                                {{ end }}
                            </div>
                        </div>
                    {{ else }}
                        <h3 id="in-this-article" class="f5 my-0">
                            <a href="#in-this-article">Table of Contents</a>
                        </h3>
                    {{ end }}
                </div>
                <div class="f6" style="max-height: calc(100vh - 8rem); overflow-y: auto;">{{ .TableOfContents }}</div>
            </div>
        </div>

        <div class="flex-1 overflow-hidden">
            <h1 class="border-bottom-0">{{.Title}}</h1>
            <p>{{.Description}}</p>

            <div>
            {{/* Check if content contains the SERIES_PAGES marker for splitting */}}
            {{ $content := .Content }}
            {{ if in $content "<!-- SERIES_PAGES -->" }}
                {{/* Split content at the marker and insert series pages */}}
                {{ $parts := split $content "<!-- SERIES_PAGES -->" }}
                {{ index $parts 0 | safeHTML }}

                {{ if isset .Params "series" }}
                    {{/* Show _index.md first if it exists, then other pages by weight */}}
                    {{ $seriesPages := .Pages }}
                    {{ if eq .Kind "page" }}
                        {{ $seriesPages = .Parent.Pages }}
                    {{ end }}

                    {{/* First render _index.md if it exists */}}
                    {{ range $seriesPages }}
                    {{ if eq .File.LogicalName "_index.md" }}
                        {{ $highlightClass := "" }}
                        {{ if .Params.highlight }}
                            {{ $highlightClass = " box-highlight" }}
                        {{ end }}
                        <div class="box Box-row--hover-gray px-3 mt-3{{ $highlightClass }}">
                            <a title="{{.Title}}" href="{{.Permalink}}">
                                <h4>{{.Title}}</h4>
                            </a>
                            <p>
                                {{.Description}}
                            </p>
                        </div>
                    {{ end }}
                    {{ end }}

                    {{/* Then render all non-index pages by weight */}}
                    {{ range $seriesPages.ByWeight }}
                    {{ if ne .File.LogicalName "_index.md" }}
                        {{ $highlightClass := "" }}
                        {{ if .Params.highlight }}
                            {{ $highlightClass = " box-highlight" }}
                        {{ end }}
                        <div class="box Box-row--hover-gray px-3 mt-3{{ $highlightClass }}">
                            <a title="{{.Title}}" href="{{.Permalink}}">
                                <h4>{{.Title}}</h4>
                            </a>
                            <p>
                                {{.Description}}
                            </p>
                        </div>
                    {{ end }}
                    {{ end }}
                    <div class="mt-5"></div>
                {{ end }}

                {{/* Render content after the marker */}}
                {{ if gt (len $parts) 1 }}
                    {{ index $parts 1 | safeHTML }}
                {{ end }}
            {{ else }}
                {{/* No marker found, use original behavior */}}
                {{.Content}}

                {{ if isset .Params "series" }}
                    {{/* Show _index.md first if it exists, then other pages by weight */}}
                    {{ $seriesPages := .Pages }}
                    {{ if eq .Kind "page" }}
                        {{ $seriesPages = .Parent.Pages }}
                    {{ end }}

                    {{/* Include current page if it's an _index.md */}}
                    {{ if and (eq .File.LogicalName "_index.md") (not (in $seriesPages .)) }}
                        {{ $seriesPages = $seriesPages | append . }}
                    {{ end }}

                    {{/* First render _index.md if it exists */}}
                    {{ range $seriesPages }}
                    {{ if eq .File.LogicalName "_index.md" }}
                        {{ $highlightClass := "" }}
                        {{ if .Params.highlight }}
                            {{ $highlightClass = " box-highlight" }}
                        {{ end }}
                        <div class="box Box-row--hover-gray px-3 mt-3{{ $highlightClass }}">
                            <a title="{{.Title}}" href="{{.Permalink}}">
                                <h4>{{.Title}}</h4>
                            </a>
                            <p>
                                {{.Description}}
                            </p>
                        </div>
                    {{ end }}
                    {{ end }}

                    {{/* Then render all non-index pages by weight */}}
                    {{ range $seriesPages.ByWeight }}
                    {{ if ne .File.LogicalName "_index.md" }}
                        {{ $highlightClass := "" }}
                        {{ if .Params.highlight }}
                            {{ $highlightClass = " box-highlight" }}
                        {{ end }}
                        <div class="box Box-row--hover-gray px-3 mt-3{{ $highlightClass }}">
                            <a title="{{.Title}}" href="{{.Permalink}}">
                                <h4>{{.Title}}</h4>
                            </a>
                            <p>
                                {{.Description}}
                            </p>
                        </div>
                    {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}

            {{ if isset .Params "series" }}
                <div class="mt-8"></div>
                <nav class="paginate-container" aria-label="Pagination">
                    <div class="pagination">
                        {{ with index .Scratch.Values "prevInSeries" }}
                        <a class="previous_page" rel="next" href="{{ .Permalink }}" aria-label="Previous Page">{{ .Title
                            }}</a>
                        {{ else }}
                        <span class="previous_page" aria-disabled="true">Previous</span>
                        {{ end }}

                        <a class="text-gray-light" href="." aria-label="Top">{{ .Name}}</a>

                        {{ with index .Scratch.Values "nextInSeries" }}
                        <a class="next_page" rel="next" href="{{ .Permalink }}" aria-label="Next Page">{{ .Title }}</a>
                        {{ else }}
                        <span class="next_page" aria-disabled="true">Next</span>
                        {{ end }}
                    </div>
                </nav>
            {{ end }}
            </div>
        </div>
    </div>
</div>

{{ end }}