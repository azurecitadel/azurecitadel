{{ define "main" }}

<div class="container-xl p-3 p-md-6 width-full">

        <!-- main header (hamburger + breadcrumbs) now rendered globally in base layout -->

        {{/* Compute series neighbors once so we can use in TOC header and footer */}}
        {{ if isset .Params "series" }}
            {{ $seriesTitle := index .Params.series 0 }}
            {{ $currentLink := .Permalink }}
            {{ $wholeSeries := (index .Site.Taxonomies.series ($seriesTitle | urlize)).Pages.ByWeight }}
            {{ range $index, $page := $wholeSeries }}
                {{ if eq $currentLink $page.Permalink }}
                    {{ if gt $index 0 }}
                        {{ .Scratch.Set "prevInSeries" (index $wholeSeries (sub $index 1)) }}
                    {{ end }}
                    {{ if lt $index (sub (len $wholeSeries) 1) }}
                        {{ .Scratch.Set "nextInSeries" (index $wholeSeries (add $index 1)) }}
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}

    <div class="d-flex flex-column flex-xl-row-reverse markdown-body">

                <div class="toc" style="flex: 0 0 300px; align-self: flex-start;">
                    <div style="position: sticky; top: 1rem; padding: 0.75rem; background: var(--color-canvas-default); border: 1px solid var(--color-border-default); border-radius: 6px; box-shadow: 0 2px 8px rgba(140,149,159,0.1);">
                        <div class="toc-header d-flex flex-items-center pb-2 mb-2 border-bottom color-border-muted">
                        {{ if isset .Params "series" }}
                            {{/* Series Progress Indicator */}}
                            {{ $seriesTitle := index .Params.series 0 }}
                            {{ $currentLink := .Permalink }}
                            {{ $wholeSeries := (index .Site.Taxonomies.series ($seriesTitle | urlize)).Pages.ByWeight }}
                            {{ $currentIndex := 0 }}
                            {{ range $index, $page := $wholeSeries }}
                                {{ if eq $currentLink $page.Permalink }}
                                    {{ $currentIndex = $index }}
                                {{ end }}
                            {{ end }}
                            <div class="series-progress-container">
                                <div class="series-name">{{ .Title }}</div>
                                <div class="series-controls">
                                    {{ with index .Scratch.Values "prevInSeries" }}
                                        <a class="btn-octicon series-btn" href="{{ .Permalink }}" aria-label="Previous in series: {{ .Title }}" title="{{ .Title }}">{{- partial "octicon" (dict "icon" "chevron-left" "height" 16) -}}</a>
                                    {{ else }}
                                        <span class="btn-octicon series-btn is-disabled" aria-disabled="true" title="No previous page">{{- partial "octicon" (dict "icon" "chevron-left" "height" 16) -}}</span>
                                    {{ end }}
                                    <div class="series-progress" aria-label="Series progress: {{ add $currentIndex 1 }} of {{ len $wholeSeries }}">
                                    {{ range $index, $page := $wholeSeries }}
                                        {{ $status := "future" }}
                                        {{ if lt $index $currentIndex }}{{ $status = "completed" }}{{ end }}
                                        {{ if eq $index $currentIndex }}{{ $status = "current" }}{{ end }}
                                        {{ if eq $index $currentIndex }}
                                            <div class="progress-bar progress-bar--{{ $status }}"
                                                 title="{{ $page.Title }}">
                                            </div>
                                        {{ else }}
                                            <a href="{{ $page.Permalink }}"
                                               class="progress-bar progress-bar--{{ $status }}"
                                               title="{{ $page.Title }}"
                                               aria-label="Go to {{ $page.Title }}">
                                            </a>
                                        {{ end }}
                                    {{ end }}
                                    </div>
                                    {{ with index .Scratch.Values "nextInSeries" }}
                                        <a class="btn-octicon series-btn" href="{{ .Permalink }}" aria-label="Next in series: {{ .Title }}" title="{{ .Title }}">{{- partial "octicon" (dict "icon" "chevron-right" "height" 16) -}}</a>
                                    {{ else }}
                                        <span class="btn-octicon series-btn is-disabled" aria-disabled="true" title="No next page">{{- partial "octicon" (dict "icon" "chevron-right" "height" 16) -}}</span>
                                    {{ end }}
                                </div>
                            </div>
                        {{ else }}
                            <h3 id="in-this-article" class="f5 my-0">
                                <a href="#in-this-article">Table of Contents</a>
                            </h3>
                        {{ end }}
                        </div>
                                        <div class="f6" style="max-height: calc(100vh - 8rem); overflow-y: auto;">{{ .TableOfContents }}</div>
                                    </div>
                                </div>

        <div class="flex-1 overflow-hidden">
            <h1 class="border-bottom-0">{{ .Title }}</h1>
            {{ if eq .Section "blog" }}
            <div class="post-subtitle text-gray">
                {{ with .Params.people }}
                    {{ $author := index . 0 }}<span>{{ $author }}</span>
                {{ end }}
                {{ if and (.Date) (ne .Date.IsZero true) }}
                    {{ if .Params.people }} &bull; {{ end }}
                    <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "02 Jan 2006" }}</time>
                {{ end }}
            </div>
            {{ end }}
                        <p>{{ .Description }}</p>

                        {{/* Print-only Table of Contents (duplicate of main TOC but inline under title) */}}
                        <div class="print-toc" style="display:none;">
                            <h2>Table of Contents</h2>
                            <nav aria-label="Table of contents">{{ .TableOfContents }}</nav>
                        </div>

                        <div>
                        {{.Content}}

                        {{/* Print footer with canonical URL */}}
                        <div class="print-footer" style="display:none;">
                            <div>Source: <span class="source-url">{{ .Permalink }}</span></div>
                            {{ with .Params.people }}<div>Author: {{ delimit . ", " }}</div>{{ end }}
                            {{ if and (.Date) (ne .Date.IsZero true) }}<div>Published: {{ .Date.Format "02 Jan 2006" }}</div>{{ end }}
                            <div>Printed: <span class="print-date"></span></div>
                            <script>try{var e=document.querySelector('.print-footer .print-date');if(e){var d=new Date();e.textContent=d.toISOString().slice(0,10);}}catch(err){}</script>
                        </div>

            {{ if isset .Params "series" }}
                <nav class="paginate-container" aria-label="Pagination">
                    <div class="pagination">
                    {{ with index .Scratch.Values "prevInSeries" }}
                        <a class="previous_page" rel="next" href="{{ .Permalink }}" aria-label="Previous Page">{{ .Title }}</a>
                    {{ else }}
                        <span class="previous_page" aria-disabled="true">Previous</span>
                    {{ end }}

                    <a class="text-gray-light" href="." aria-label="Top">{{ .Name}}</a>

                    {{ with index .Scratch.Values "nextInSeries" }}
                        <a class="next_page" rel="next" href="{{ .Permalink }}" aria-label="Next Page">{{ .Title }}</a>
                    {{ else }}
                        <span class="next_page" aria-disabled="true">Next</span>
                    {{ end }}
                    </div>
                </nav>

            {{ end }}

        </div>
    </div>
</div>

{{ end }}